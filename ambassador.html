<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AZ Learner - Ambassador Portal</title>
    <link rel="icon" type="image/png" href="favicon1.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Roboto', 'sans-serif'] },
                    colors: {
                        blueAccent: '#448AFF',
                        orangeAccent: '#FFAB40',
                        darkBg: '#111827',
                        darkCard: '#2d2d2d',
                        success: '#00E676'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            background: linear-gradient(-45deg, #020617, #0f172a, #1e3a8a, #172554);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: white;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="font-sans antialiased h-screen flex flex-col">

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] bg-gray-900 flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-sm glass-panel p-8 rounded-2xl shadow-2xl text-center">
            <div class="text-6xl mb-4">ðŸŽ“</div>
            <h1 class="text-3xl font-black text-orangeAccent mb-2 tracking-tighter">Ambassador Portal</h1>
            <p class="text-sm text-gray-400 mb-6">Access Restricted to Ambassadors & Admins</p>
            <input type="email" id="login-email" placeholder="Email"
                class="w-full mb-3 p-3 rounded-lg bg-gray-700 outline-none text-white border border-gray-600 focus:border-orangeAccent transition-colors">
            <input type="password" id="login-pass" placeholder="Password"
                class="w-full mb-6 p-3 rounded-lg bg-gray-700 outline-none text-white border border-gray-600 focus:border-orangeAccent transition-colors">
            <button onclick="authManager.login()"
                class="w-full py-3 bg-gradient-to-r from-orangeAccent to-orange-600 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform mb-4">
                Enter Portal ðŸš€
            </button>
            <p id="login-msg" class="text-red-500 text-xs h-4"></p>
            <div class="mt-6 pt-6 border-t border-gray-700">
                <a href="index.html" class="text-gray-400 hover:text-white text-sm transition">
                    <i class="fas fa-arrow-left"></i> Back to Home
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app-content" class="hidden flex-1 flex flex-col h-full">
        <!-- Header -->
        <div class="glass-panel border-b border-gray-700/50 px-6 py-4 flex justify-between items-center shrink-0 shadow-md z-10">
            <div>
                <h1 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orangeAccent to-yellow-200">
                    AZ AMBASSADOR PORTAL
                </h1>
                <p id="user-name-display" class="text-xs text-gray-400 font-mono">Loading...</p>
            </div>
            <button onclick="authManager.logout()"
                class="bg-gray-700 hover:bg-red-900/80 text-white px-4 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2">
                Sign Out <i class="fa-solid fa-power-off"></i>
            </button>
        </div>

        <!-- Tab Navigation -->
        <div class="glass-panel border-b border-gray-700/50 px-4 py-2 overflow-x-auto flex gap-2 shrink-0 z-10">
            <button onclick="portal.switchTab('profile')" id="tab-profile" 
                class="portal-tab px-4 py-2 rounded text-xs font-bold transition bg-blueAccent text-white whitespace-nowrap">
                <i class="fa-solid fa-user"></i> Profile
            </button>
            <button onclick="portal.switchTab('programs')" id="tab-programs" 
                class="portal-tab px-4 py-2 rounded text-xs font-bold transition text-gray-400 hover:text-white whitespace-nowrap">
                <i class="fa-solid fa-calendar"></i> Programs
            </button>
            <button onclick="portal.switchTab('courses')" id="tab-courses" 
                class="portal-tab px-4 py-2 rounded text-xs font-bold transition text-gray-400 hover:text-white whitespace-nowrap">
                <i class="fa-solid fa-book"></i> Courses
            </button>
            <button onclick="portal.switchTab('leaderboard')" id="tab-leaderboard"
                class="portal-tab px-4 py-2 rounded text-xs font-bold transition text-gray-400 hover:text-white whitespace-nowrap">
                <i class="fa-solid fa-trophy"></i> Leaderboard
            </button>
            <button onclick="portal.switchTab('challenges')" id="tab-challenges"
                class="portal-tab px-4 py-2 rounded text-xs font-bold transition text-gray-400 hover:text-white whitespace-nowrap">
                <i class="fa-solid fa-star"></i> Challenges
            </button>
        </div>

        <!-- Tab Content -->
        <div class="flex-1 overflow-y-auto p-4 md:p-6">
            
            <!-- Profile Tab -->
            <div id="view-profile" class="portal-view">
                <div class="max-w-4xl mx-auto space-y-6">
                    <div class="glass-panel rounded-2xl p-8">
                        <div class="flex items-center gap-6 mb-6">
                            <div class="w-24 h-24 bg-gradient-to-br from-orangeAccent to-orange-600 rounded-full flex items-center justify-center text-4xl font-bold">
                                <span id="profile-initials">?</span>
                            </div>
                            <div>
                                <h2 class="text-3xl font-bold text-white" id="profile-name">Loading...</h2>
                                <p class="text-gray-400" id="profile-email">Loading...</p>
                                <div class="mt-2">
                                    <span class="bg-orange-900/30 text-orange-400 px-3 py-1 rounded-full text-xs font-bold" id="profile-role">Ambassador</span>
                                </div>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-sm font-bold text-gray-400 uppercase mb-3">Academic Information</h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">University:</span>
                                        <span class="text-white font-bold" id="profile-university">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">Major:</span>
                                        <span class="text-white" id="profile-major">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">Year:</span>
                                        <span class="text-white" id="profile-year">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">GPA:</span>
                                        <span class="text-white" id="profile-gpa">-</span>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h3 class="text-sm font-bold text-gray-400 uppercase mb-3">Contact Information</h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">Phone:</span>
                                        <span class="text-white" id="profile-phone">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">Date of Birth:</span>
                                        <span class="text-white" id="profile-dob">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">Social Media:</span>
                                        <span class="text-white" id="profile-social">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 pt-6 border-t border-gray-700">
                            <h3 class="text-sm font-bold text-gray-400 uppercase mb-3">Ambassador Status</h3>
                            <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-4">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-check-circle text-green-400 text-2xl"></i>
                                    <div>
                                        <p class="text-white font-bold">Active Ambassador</p>
                                        <p class="text-xs text-gray-400" id="profile-approved">Approved on: Loading...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid md:grid-cols-3 gap-4">
                        <div class="glass-panel rounded-xl p-6">
                            <div class="flex items-center gap-3">
                                <div class="bg-blue-500/20 p-3 rounded-lg">
                                    <i class="fas fa-calendar text-blue-400 text-2xl"></i>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-400">Programs Attended</p>
                                    <p class="text-2xl font-bold text-white" id="stat-programs">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass-panel rounded-xl p-6">
                            <div class="flex items-center gap-3">
                                <div class="bg-orange-500/20 p-3 rounded-lg">
                                    <i class="fas fa-book text-orange-400 text-2xl"></i>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-400">Courses Available</p>
                                    <p class="text-2xl font-bold text-white" id="stat-courses">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass-panel rounded-xl p-6">
                            <div class="flex items-center gap-3">
                                <div class="bg-green-500/20 p-3 rounded-lg">
                                    <i class="fas fa-trophy text-green-400 text-2xl"></i>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-400">Achievement Points</p>
                                    <p class="text-2xl font-bold text-white">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Programs Tab -->
            <div id="view-programs" class="portal-view hidden">
                <div class="max-w-4xl mx-auto space-y-6">
                    <div class="glass-panel rounded-2xl p-8">
                        <h2 class="text-2xl font-bold text-white mb-2">
                            <i class="fas fa-calendar-alt"></i> Ambassador Programs
                        </h2>
                        <p class="text-gray-400 text-sm mb-6">View and join upcoming programs and events</p>
                        
                        <div id="programs-list" class="space-y-4">
                            <div class="text-center text-gray-500 py-8">Loading programs...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Courses Tab -->
            <div id="view-courses" class="portal-view hidden">
                <div class="max-w-4xl mx-auto space-y-6">
                    <div class="glass-panel rounded-2xl p-8">
                        <h2 class="text-2xl font-bold text-white mb-2">
                            <i class="fas fa-graduation-cap"></i> Training & Resources
                        </h2>
                        <p class="text-gray-400 text-sm mb-6">Access exclusive ambassador training materials</p>
                        
                        <div id="courses-grid" class="grid md:grid-cols-2 gap-6">
                            <div class="text-center text-gray-500 py-8 col-span-2">Loading courses...</div>
                        </div>

                        <div class="mt-8 p-6 bg-blue-900/20 border border-blue-500/30 rounded-xl">
                            <h3 class="text-lg font-bold text-white mb-2">
                                <i class="fas fa-download"></i> Resource Library
                            </h3>
                            <p class="text-sm text-gray-400 mb-4">Download ambassador guides, templates, and promotional materials</p>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition">
                                Browse Resources
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leaderboard Tab -->
            <div id="view-leaderboard" class="portal-view hidden">
                <div class="max-w-4xl mx-auto space-y-6">
                    <div class="glass-panel rounded-2xl p-8">
                        <h2 class="text-2xl font-bold text-white mb-2">
                            <i class="fas fa-trophy text-yellow-400"></i> Ambassador Leaderboard
                        </h2>
                        <p class="text-gray-400 text-sm mb-6">Top ambassadors ranked by achievement points this month</p>
                        <div id="leaderboard-list" class="space-y-3">
                            <div class="text-center text-gray-500 py-8">Loading leaderboard...</div>
                        </div>
                    </div>
                    <div class="glass-panel rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-white mb-4"><i class="fas fa-star text-orangeAccent"></i> How to Earn Points</h3>
                        <div class="grid md:grid-cols-2 gap-4 text-sm">
                            <div class="flex items-center gap-3 bg-blue-900/20 border border-blue-500/30 rounded-lg p-3">
                                <i class="fas fa-calendar text-blue-400 text-xl"></i>
                                <div><p class="text-white font-bold">Attend a Program</p><p class="text-gray-400">+50 points</p></div>
                            </div>
                            <div class="flex items-center gap-3 bg-green-900/20 border border-green-500/30 rounded-lg p-3">
                                <i class="fas fa-book text-green-400 text-xl"></i>
                                <div><p class="text-white font-bold">Complete a Course</p><p class="text-gray-400">+100 points</p></div>
                            </div>
                            <div class="flex items-center gap-3 bg-orange-900/20 border border-orange-500/30 rounded-lg p-3">
                                <i class="fas fa-user-plus text-orange-400 text-xl"></i>
                                <div><p class="text-white font-bold">Recruit a Student</p><p class="text-gray-400">+75 points per referral</p></div>
                            </div>
                            <div class="flex items-center gap-3 bg-purple-900/20 border border-purple-500/30 rounded-lg p-3">
                                <i class="fas fa-tasks text-purple-400 text-xl"></i>
                                <div><p class="text-white font-bold">Complete a Challenge</p><p class="text-gray-400">+200 points bonus</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Challenges Tab -->
            <div id="view-challenges" class="portal-view hidden">
                <div class="max-w-4xl mx-auto space-y-6">
                    <div class="glass-panel rounded-2xl p-8">
                        <h2 class="text-2xl font-bold text-white mb-2">
                            <i class="fas fa-star text-yellow-400"></i> Monthly Challenges
                        </h2>
                        <p class="text-gray-400 text-sm mb-6">Complete all tasks this month to earn a bonus badge and 200 extra points!</p>
                        <div id="challenges-list" class="space-y-4">
                            <!-- Hardcoded monthly challenges -->
                            <div class="bg-blue-900/20 border border-blue-500/30 rounded-xl p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-white"><i class="fas fa-fire text-orange-400"></i> February 2026 Challenge</h3>
                                    <span class="bg-green-900/30 text-green-400 text-xs font-bold px-3 py-1 rounded-full">Active</span>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex items-center gap-3 p-3 bg-gray-800/50 rounded-lg cursor-pointer hover:bg-gray-700/50 transition" onclick="portal.toggleChallenge(this)">
                                        <div class="w-6 h-6 rounded-full border-2 border-gray-500 flex items-center justify-center challenge-check flex-shrink-0"></div>
                                        <div>
                                            <p class="text-white text-sm font-bold">Recruit 2 new students using your referral link</p>
                                            <p class="text-gray-400 text-xs">+75 points each</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3 p-3 bg-gray-800/50 rounded-lg cursor-pointer hover:bg-gray-700/50 transition" onclick="portal.toggleChallenge(this)">
                                        <div class="w-6 h-6 rounded-full border-2 border-gray-500 flex items-center justify-center challenge-check flex-shrink-0"></div>
                                        <div>
                                            <p class="text-white text-sm font-bold">Complete the Marketing &amp; Outreach course</p>
                                            <p class="text-gray-400 text-xs">+100 points</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3 p-3 bg-gray-800/50 rounded-lg cursor-pointer hover:bg-gray-700/50 transition" onclick="portal.toggleChallenge(this)">
                                        <div class="w-6 h-6 rounded-full border-2 border-gray-500 flex items-center justify-center challenge-check flex-shrink-0"></div>
                                        <div>
                                            <p class="text-white text-sm font-bold">Attend one ambassador program or event</p>
                                            <p class="text-gray-400 text-xs">+50 points</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3 p-3 bg-gray-800/50 rounded-lg cursor-pointer hover:bg-gray-700/50 transition" onclick="portal.toggleChallenge(this)">
                                        <div class="w-6 h-6 rounded-full border-2 border-gray-500 flex items-center justify-center challenge-check flex-shrink-0"></div>
                                        <div>
                                            <p class="text-white text-sm font-bold">Share AZ Learner on social media and tag us</p>
                                            <p class="text-gray-400 text-xs">+25 points</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3 p-3 bg-gray-800/50 rounded-lg cursor-pointer hover:bg-gray-700/50 transition" onclick="portal.toggleChallenge(this)">
                                        <div class="w-6 h-6 rounded-full border-2 border-gray-500 flex items-center justify-center challenge-check flex-shrink-0"></div>
                                        <div>
                                            <p class="text-white text-sm font-bold">Nominate a peer for the Spotlight badge</p>
                                            <p class="text-gray-400 text-xs">+25 points</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4 pt-4 border-t border-gray-700 flex items-center gap-3">
                                    <div class="flex-1 bg-gray-700 rounded-full h-2">
                                        <div id="challenge-progress-bar" class="bg-gradient-to-r from-orange-500 to-yellow-400 h-2 rounded-full transition-all" style="width: 0%"></div>
                                    </div>
                                    <span id="challenge-progress-text" class="text-xs text-gray-400 font-bold">0/5 tasks</span>
                                </div>
                                <div id="challenge-bonus" class="hidden mt-3 p-3 bg-yellow-900/20 border border-yellow-500/30 rounded-lg text-center">
                                    <p class="text-yellow-400 font-bold">ðŸŽ‰ Challenge Complete! You earned the <span class="text-white">February Champion</span> badge and +200 bonus points!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="glass-panel rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-white mb-2"><i class="fas fa-medal text-yellow-400"></i> Your Badges</h3>
                        <p class="text-gray-400 text-sm mb-4">Badges you've earned through challenges and achievements</p>
                        <div class="flex flex-wrap gap-3" id="badges-display">
                            <div class="flex items-center gap-2 bg-gray-800 border border-gray-600 rounded-full px-4 py-2 text-sm text-gray-400">
                                <i class="fas fa-lock text-xs"></i> Complete a challenge to earn your first badge
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Course Detail Modal -->
    <div id="course-modal" class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 hidden" onclick="portal.closeCourseModal(event)">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-2xl max-h-[85vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div id="course-modal-header" class="p-6 border-b border-gray-700 flex justify-between items-start sticky top-0 bg-gray-900 z-10">
                <div class="flex items-center gap-4">
                    <div id="course-modal-icon-wrap" class="p-3 rounded-lg">
                        <i id="course-modal-icon" class="fas text-2xl"></i>
                    </div>
                    <div>
                        <h2 id="course-modal-title" class="text-xl font-bold text-white"></h2>
                        <p id="course-modal-desc" class="text-gray-400 text-sm mt-1"></p>
                    </div>
                </div>
                <button onclick="portal.closeCourseModal()" class="text-gray-400 hover:text-white text-xl ml-4 flex-shrink-0">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <h3 class="text-sm font-bold text-gray-400 uppercase mb-4">Course Modules</h3>
                <div id="course-modal-modules" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <!-- Firebase Integration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, onSnapshot, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCKpJ7YzuHMTaTC3jXFWiEPmuwdTU4h96Y",
            authDomain: "az-learner.firebaseapp.com",
            projectId: "az-learner",
            storageBucket: "az-learner.firebasestorage.app",
            messagingSenderId: "12958795950",
            appId: "1:12958795950:web:326411293864571040453f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUser = null;
        let isAmbassador = false;

        window.authManager = {
            async login() {
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-pass').value;
                const msg = document.getElementById('login-msg');

                if (!email || !pass) {
                    msg.innerText = 'Please enter email and password';
                    return;
                }

                try {
                    const userCredential = await signInWithEmailAndPassword(auth, email, pass);
                    // Auth state change handler will take care of the rest
                } catch (error) {
                    msg.innerText = 'Invalid credentials';
                    console.error('Login error:', error);
                }
            },

            async logout() {
                await signOut(auth);
                location.reload();
            }
        };

        window.portal = {
            init() {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Check if user is admin or ambassador
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            
                            // Admins are automatically ambassadors
                            if (userData.role === 'admin') {
                                isAmbassador = true;
                                currentUser = { 
                                    ...userData, 
                                    uid: user.uid,
                                    isAdmin: true 
                                };
                                this.showPortal(currentUser);
                                return;
                            }
                        }

                        // Check if user is an approved ambassador
                        const ambassadorQuery = query(
                            collection(db, 'ambassadors'),
                            where('email', '==', user.email)
                        );
                        const ambassadorSnap = await getDocs(ambassadorQuery);

                        if (!ambassadorSnap.empty) {
                            isAmbassador = true;
                            const ambassadorData = ambassadorSnap.docs[0].data();
                            currentUser = { 
                                ...ambassadorData, 
                                uid: user.uid,
                                isAdmin: false 
                            };
                            this.showPortal(currentUser);
                        } else {
                            alert('Access Denied: You are not an approved ambassador. Please submit an application at ambassadorsignup.html or contact support for assistance.');
                            signOut(auth);
                        }
                    } else {
                        document.getElementById('auth-overlay').classList.remove('hidden');
                        document.getElementById('app-content').classList.add('hidden');
                    }
                });
            },

            showPortal(userData) {
                document.getElementById('auth-overlay').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                
                const displayName = userData.name || userData.fullName || 'Ambassador';
                document.getElementById('user-name-display').innerText = `Welcome, ${displayName}`;
                
                this.loadProfile(userData);
                this.loadPrograms();
                this.loadCourses();
                this.loadLeaderboard();
                this.loadChallenges();
                this.switchTab('profile');
            },

            loadProfile(userData) {
                // Set initials
                const name = userData.name || userData.fullName || '?';
                const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                document.getElementById('profile-initials').innerText = initials;
                
                // Set profile data
                document.getElementById('profile-name').innerText = name;
                document.getElementById('profile-email').innerText = userData.email || '-';
                document.getElementById('profile-university').innerText = userData.university || '-';
                document.getElementById('profile-major').innerText = userData.major || '-';
                document.getElementById('profile-year').innerText = userData.year || '-';
                document.getElementById('profile-gpa').innerText = userData.gpa || '-';
                document.getElementById('profile-phone').innerText = userData.phone || '-';
                document.getElementById('profile-dob').innerText = userData.dob || '-';
                document.getElementById('profile-social').innerText = userData.socialMedia || '-';
                
                if (userData.isAdmin) {
                    document.getElementById('profile-role').innerText = 'Admin (Default Ambassador)';
                    document.getElementById('profile-role').classList.remove('bg-orange-900/30', 'text-orange-400');
                    document.getElementById('profile-role').classList.add('bg-purple-900/30', 'text-purple-400');
                    document.getElementById('profile-approved').innerText = 'Admin - Default Ambassador Status';
                } else if (userData.approvedAt && typeof userData.approvedAt.toDate === 'function') {
                    const approvedDate = new Date(userData.approvedAt.toDate()).toLocaleDateString();
                    const approvedBy = userData.approvedBy || 'Admin';
                    document.getElementById('profile-approved').innerText = `Approved on: ${approvedDate} by ${approvedBy}`;
                } else {
                    document.getElementById('profile-approved').innerText = 'Ambassador Status: Active';
                }
            },

            loadPrograms() {
                onSnapshot(
                    query(collection(db, 'ambassador_programs'), orderBy('createdAt', 'desc')),
                    (snap) => {
                        const programsList = document.getElementById('programs-list');
                        programsList.innerHTML = '';
                        
                        if (snap.empty) {
                            programsList.innerHTML = '<div class="text-center text-gray-500 py-8">No programs scheduled yet</div>';
                        } else {
                            document.getElementById('stat-programs').innerText = snap.size;
                            
                            snap.forEach(d => {
                                const prog = d.data();
                                const programDate = new Date(prog.date).toLocaleString();
                                const isPast = new Date(prog.date) < new Date();
                                
                                programsList.innerHTML += `
                                    <div class="bg-gray-800/50 border ${isPast ? 'border-gray-700' : 'border-blue-500/30'} rounded-xl p-6">
                                        <div class="flex justify-between items-start mb-3">
                                            <h3 class="text-xl font-bold text-white">${prog.title}</h3>
                                            <span class="px-3 py-1 rounded-full text-xs font-bold ${isPast ? 'bg-gray-700 text-gray-400' : 'bg-blue-900/30 text-blue-400'}">
                                                ${isPast ? 'Past Event' : 'Upcoming'}
                                            </span>
                                        </div>
                                        <p class="text-gray-300 mb-4">${prog.description}</p>
                                        <div class="flex items-center gap-4 text-sm text-gray-400">
                                            <span><i class="fas fa-calendar"></i> ${programDate}</span>
                                            ${prog.link !== 'TBD' ? `<a href="${prog.link}" target="_blank" class="text-blue-400 hover:underline"><i class="fas fa-link"></i> Join Link</a>` : ''}
                                        </div>
                                    </div>
                                `;
                            });
                        }
                    }
                );
            },

            async loadCourses() {
                const COLOR_CLASSES = {
                    blue:   { bg: 'bg-blue-900/20',   border: 'border-blue-500/30',   iconBg: 'bg-blue-500/20',   icon: 'text-blue-400',   badge: 'text-blue-400'   },
                    orange: { bg: 'bg-orange-900/20', border: 'border-orange-500/30', iconBg: 'bg-orange-500/20', icon: 'text-orange-400', badge: 'text-orange-400' },
                    green:  { bg: 'bg-green-900/20',  border: 'border-green-500/30',  iconBg: 'bg-green-500/20',  icon: 'text-green-400',  badge: 'text-green-400'  },
                    purple: { bg: 'bg-purple-900/20', border: 'border-purple-500/30', iconBg: 'bg-purple-500/20', icon: 'text-purple-400', badge: 'text-purple-400' },
                };

                const HARDCODED_COURSES = [
                    {
                        id: 'marketing-outreach',
                        title: 'Marketing & Outreach',
                        description: 'Promote AZ Learner on campus effectively and grow your student community.',
                        color: 'blue', icon: 'bullhorn',
                        modules: [
                            { order: 1, title: 'Understanding Your Audience', type: 'text', content: 'Identify student personas on your campus â€” what courses they take, what challenges they face, and what motivates them to seek learning tools. Map out key student hotspots: libraries, study halls, faculty notice boards, and online groups.' },
                            { order: 2, title: 'Social Media Strategy', type: 'text', content: 'Create a content calendar for Instagram, TikTok, and WhatsApp. Use short-form video to showcase AZ Learner features. Post at least 3 times per week during exam season. Always include a clear call-to-action and your personal referral link.' },
                            { order: 3, title: 'Campus Tabling & Flyers', type: 'text', content: 'Set up a table near high-traffic areas. Prepare a short 60-second pitch about AZ Learner. Use printed QR codes that link to the sign-up page with your referral code embedded. Collect emails for follow-up.' },
                            { order: 4, title: 'Measuring Your Impact', type: 'text', content: 'Track referral sign-ups through your unique referral code on the portal. Record attendance at your events. Set a personal monthly target of 10 new students. Report your numbers in the monthly ambassador digest.' }
                        ]
                    },
                    {
                        id: 'leadership-development',
                        title: 'Leadership Development',
                        description: 'Build essential leadership skills to manage study groups and mentor your peers.',
                        color: 'orange', icon: 'users',
                        modules: [
                            { order: 1, title: 'Leadership Styles & Principles', type: 'text', content: 'Explore the four core leadership styles: directive, coaching, supporting, and delegating. Understand when to use each style. Great ambassadors adapt their approach to each situation â€” firm deadlines may need directive leadership, while mentoring calls for a coaching style.' },
                            { order: 2, title: 'Running Effective Study Groups', type: 'text', content: 'Host study circles around specific AZ Learner courses. Set a clear agenda 24 hours in advance. Keep sessions to 60â€“90 minutes. Assign roles: timekeeper, note-taker, question-master. End every session with a brief quiz or reflection exercise.' },
                            { order: 3, title: 'Peer Mentoring Techniques', type: 'text', content: 'Mentoring is about listening first. Use the GROW model: Goal, Reality, Options, Way Forward. Check in with your mentees weekly via WhatsApp. Celebrate small wins. Escalate any welfare concerns to the AZ Learner core team.' },
                            { order: 4, title: 'Conflict Resolution', type: 'text', content: 'Conflicts arise in every team. Use the DESC framework: Describe the behaviour, Express how it affects you, Specify what you need, and Commit to a shared outcome. Address issues early â€” unresolved tension undermines group performance.' }
                        ]
                    },
                    {
                        id: 'communication-skills',
                        title: 'Communication Skills',
                        description: 'Engage students and the core team clearly through confident verbal and written communication.',
                        color: 'green', icon: 'comments',
                        modules: [
                            { order: 1, title: 'Foundations of Effective Communication', type: 'text', content: 'Communication is 7% words, 38% tone, and 55% body language. As an ambassador, your presence matters as much as your message. Practice open body language, make eye contact, and speak at a measured pace. Tailor vocabulary to your audience â€” avoid jargon with new students.' },
                            { order: 2, title: 'Public Speaking Fundamentals', type: 'text', content: 'Prepare with the 3-T method: Tell them what you\'ll tell them, Tell them, Tell them what you told them. Manage nerves through deep breathing and power posing before presentations. Record yourself to identify filler words. Every ambassador should be able to deliver a compelling 2-minute pitch about AZ Learner from memory.' },
                            { order: 3, title: 'Digital & Written Communication', type: 'text', content: 'Write clear WhatsApp and email messages: one topic per message, a clear ask, and a deadline. Use bullet points for long updates. Proofread before sending official communications. Use the AZ Learner tone â€” friendly, encouraging, and professional.' },
                            { order: 4, title: 'Active Listening', type: 'text', content: 'Active listening means fully concentrating on the speaker rather than preparing your response. Techniques: paraphrase what you heard, ask open-ended questions ("Can you tell me more?"), avoid interrupting, and summarise at the end. Apply this in study circles and one-on-one mentoring sessions.' }
                        ]
                    },
                    {
                        id: 'event-planning',
                        title: 'Event Planning',
                        description: 'Organise impactful study sessions and campus events that bring students together.',
                        color: 'purple', icon: 'chart-line',
                        modules: [
                            { order: 1, title: 'Event Planning Basics', type: 'text', content: 'Every successful event has five phases: Concept, Planning, Promotion, Execution, and Review. Start planning at least two weeks in advance. Define clear outcomes â€” what should attendees know or be able to do after your event? Choose a venue (physical or virtual) based on your expected audience size.' },
                            { order: 2, title: 'Promoting Your Event', type: 'text', content: 'Use the 3-7-1 rule: post about your event 3 weeks, 7 days, and 1 day before. Use visual flyers with the AZ Learner branding (download from the Resource Library). Create a WhatsApp event group. Send personalised invites to key students. Target course reps and student union officers for wider reach.' },
                            { order: 3, title: 'Running Virtual Study Sessions', type: 'text', content: 'Host study sessions on Google Meet or Zoom. Share the agenda in the meeting chat at the start. Use breakout rooms for small group discussion. Record sessions (with consent) and share the link via AZ Learner. Collect attendance by asking participants to react or sign in on a shared Google Sheet.' },
                            { order: 4, title: 'Post-Event Follow-Up', type: 'text', content: 'Send a thank-you message within 24 hours. Share a brief summary and any resources discussed. Collect feedback using a short Google Form (3â€“5 questions). Log attendance in the portal for achievement points. Write a short event report and submit it to the core team for the monthly digest.' }
                        ]
                    }
                ];

                const coursesGrid = document.getElementById('courses-grid');
                let courses = [];

                try {
                    const snap = await getDocs(
                        query(collection(db, 'courses'), where('isPublished', '==', true))
                    );
                    if (!snap.empty) {
                        snap.forEach(docSnap => courses.push({ id: docSnap.id, ...docSnap.data() }));
                    }
                } catch (e) {
                    // Firestore unavailable â€” use hardcoded courses
                }

                if (courses.length === 0) {
                    courses = HARDCODED_COURSES;
                }

                // Store courses for openCourse modal
                window._portalCourses = courses;

                coursesGrid.innerHTML = '';
                document.getElementById('stat-courses').innerText = courses.length;

                courses.forEach(c => {
                    const cls = COLOR_CLASSES[c.color] ?? COLOR_CLASSES.blue;

                    const card = document.createElement('div');
                    card.className = `${cls.bg} border ${cls.border} rounded-xl p-6 hover:opacity-90 transition cursor-pointer`;
                    card.addEventListener('click', () => portal.openCourse(c.id));

                    const inner = document.createElement('div');
                    inner.className = 'flex items-start gap-4';

                    const iconWrap = document.createElement('div');
                    iconWrap.className = `${cls.iconBg} p-3 rounded-lg`;
                    const icon = document.createElement('i');
                    icon.className = `fas fa-${c.icon} ${cls.icon} text-2xl`;
                    iconWrap.appendChild(icon);

                    const textWrap = document.createElement('div');

                    const title = document.createElement('h3');
                    title.className = 'text-lg font-bold text-white mb-1';
                    title.textContent = c.title;

                    const desc = document.createElement('p');
                    desc.className = 'text-sm text-gray-400 mb-3';
                    desc.textContent = c.description;

                    const badge = document.createElement('span');
                    badge.className = `text-xs ${cls.badge} font-bold`;
                    badge.textContent = `${c.modules?.length ?? 0} modules`;

                    textWrap.append(title, desc, badge);
                    inner.append(iconWrap, textWrap);
                    card.appendChild(inner);
                    coursesGrid.appendChild(card);
                });
            },

            openCourse(courseId) {
                const courses = window._portalCourses || [];
                const course = courses.find(c => c.id === courseId);
                if (!course) return;

                const COLOR_CLASSES = {
                    blue:   { iconBg: 'bg-blue-500/20', icon: 'text-blue-400' },
                    orange: { iconBg: 'bg-orange-500/20', icon: 'text-orange-400' },
                    green:  { iconBg: 'bg-green-500/20', icon: 'text-green-400' },
                    purple: { iconBg: 'bg-purple-500/20', icon: 'text-purple-400' },
                };
                const cls = COLOR_CLASSES[course.color] ?? COLOR_CLASSES.blue;

                document.getElementById('course-modal-title').textContent = course.title;
                document.getElementById('course-modal-desc').textContent = course.description;
                document.getElementById('course-modal-icon').className = `fas fa-${course.icon} ${cls.icon} text-2xl`;
                document.getElementById('course-modal-icon-wrap').className = `${cls.iconBg} p-3 rounded-lg`;

                const modulesEl = document.getElementById('course-modal-modules');
                modulesEl.innerHTML = '';
                (course.modules || []).forEach(mod => {
                    const el = document.createElement('div');
                    el.className = 'bg-gray-800/60 border border-gray-700 rounded-xl overflow-hidden';

                    const header = document.createElement('button');
                    header.className = 'w-full flex items-center gap-3 p-4 text-left hover:bg-gray-700/50 transition';
                    header.innerHTML = `
                        <span class="w-7 h-7 rounded-full bg-gray-700 flex items-center justify-center text-xs font-bold text-white flex-shrink-0">${mod.order}</span>
                        <span class="text-white font-bold flex-1">${mod.title}</span>
                        <i class="fas fa-chevron-down text-gray-400 text-xs transition-transform module-chevron"></i>
                    `;

                    const body = document.createElement('div');
                    body.className = 'px-4 pb-4 hidden text-gray-300 text-sm leading-relaxed';
                    body.textContent = mod.content || '';

                    header.addEventListener('click', () => {
                        const isOpen = !body.classList.contains('hidden');
                        body.classList.toggle('hidden', isOpen);
                        header.querySelector('.module-chevron').style.transform = isOpen ? '' : 'rotate(180deg)';
                    });

                    el.append(header, body);
                    modulesEl.appendChild(el);
                });

                document.getElementById('course-modal').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            },

            closeCourseModal(event) {
                if (event && event.target !== document.getElementById('course-modal')) return;
                document.getElementById('course-modal').classList.add('hidden');
                document.body.style.overflow = '';
            },

            async loadLeaderboard() {
                const list = document.getElementById('leaderboard-list');
                try {
                    const snap = await getDocs(
                        query(collection(db, 'ambassadors'), orderBy('achievementPoints', 'desc'))
                    );
                    if (snap.empty) throw new Error('empty');
                    list.innerHTML = '';
                    let rank = 1;
                    snap.forEach(d => {
                        const a = d.data();
                        const medal = rank === 1 ? 'ðŸ¥‡' : rank === 2 ? 'ðŸ¥ˆ' : rank === 3 ? 'ðŸ¥‰' : `#${rank}`;
                        const name = a.name || a.fullName || 'Ambassador';
                        const points = a.achievementPoints ?? 0;
                        const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                        list.innerHTML += `
                            <div class="flex items-center gap-4 p-4 bg-gray-800/50 border border-gray-700/50 rounded-xl">
                                <span class="text-2xl w-10 text-center">${medal}</span>
                                <div class="w-10 h-10 bg-gradient-to-br from-orangeAccent to-orange-600 rounded-full flex items-center justify-center text-sm font-bold">${initials}</div>
                                <div class="flex-1">
                                    <p class="text-white font-bold text-sm">${name}</p>
                                    <p class="text-gray-400 text-xs">${a.university || 'Ambassador'}</p>
                                </div>
                                <span class="text-orangeAccent font-bold">${points} pts</span>
                            </div>`;
                        rank++;
                    });
                } catch (e) {
                    list.innerHTML = '<div class="text-center text-gray-500 py-8">No leaderboard data yet â€” start completing courses and attending programs to earn points!</div>';
                }
            },

            loadChallenges() {
                // Challenges are hardcoded in the HTML â€” update progress bar on load
                this._updateChallengeProgress();
            },

            toggleChallenge(row) {
                const check = row.querySelector('.challenge-check');
                const isDone = check.classList.contains('bg-green-500');
                check.classList.toggle('bg-green-500', !isDone);
                check.classList.toggle('border-green-500', !isDone);
                check.classList.toggle('border-gray-500', isDone);
                check.innerHTML = isDone ? '' : '<i class="fas fa-check text-white text-xs"></i>';
                const title = row.querySelector('p.text-white');
                title.classList.toggle('line-through', !isDone);
                title.classList.toggle('opacity-50', !isDone);
                this._updateChallengeProgress();
            },

            _updateChallengeProgress() {
                const rows = document.querySelectorAll('#challenges-list .challenge-check');
                const done = [...rows].filter(c => c.classList.contains('bg-green-500')).length;
                const total = rows.length;
                const pct = total ? Math.round((done / total) * 100) : 0;
                const bar = document.getElementById('challenge-progress-bar');
                const text = document.getElementById('challenge-progress-text');
                const bonus = document.getElementById('challenge-bonus');
                if (bar) bar.style.width = pct + '%';
                if (text) text.textContent = `${done}/${total} tasks`;
                if (bonus) bonus.classList.toggle('hidden', done < total);
            },

            switchTab(tab) {
                // Hide all views
                document.querySelectorAll('.portal-view').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${tab}`).classList.remove('hidden');

                // Update tab buttons
                document.querySelectorAll('.portal-tab').forEach(btn => {
                    btn.classList.remove('bg-blueAccent', 'text-white');
                    btn.classList.add('text-gray-400');
                });
                document.getElementById(`tab-${tab}`).classList.remove('text-gray-400');
                document.getElementById(`tab-${tab}`).classList.add('bg-blueAccent', 'text-white');
            }
        };

        window.addEventListener('DOMContentLoaded', () => portal.init());
    </script>
</body>
</html>
